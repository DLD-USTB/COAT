## CPU模型与单周期处理器

### ISA层次下的CPU模型
抽象，是计算机科学中的一个重要的方法。抽象能帮助我们忽略一些不那么重要的细节，专注于问题的本质，从而更好的解决问题。ISA（Instruction Set Architecture，指令集架构）正是这一一个抽象层。ISA是计算机软硬件的分界面，规范硬件设计，指导软件使用硬件。

对于运行在ISA层次之上的软件来说，它们并不需要知道关于处理器实现的所有细节，他们只要保证ISA描述的处理器模型即可。对于软件来说，它们可见的处理器模型，包括通用寄存器，程序计数器，内存等。处理器执行程序的过程，就是在一系列由这些存储部件构成的状态机在指令控制下发生转换的过程。比方说我们在MIPS架构处理器上执行一条加法指令`addiu, $1,$0,42`，就会让处理器中的PC和$1寄存器状态发生转换，让`PC`变成`PC+4`，让`$1`变成42。我们将通用寄存器，程序计数器，内存等ISA规范规定的软件可见的内容称为ISA层面的处理器状态。

一种ISA，可以有很多种不同的处理器实现，我们可以实现一个单周期处理器，或是一个流水线处理器，甚至我们可以用软件构建这样一个处理器（QEMU，NEMU等软件模拟器）。只要确保软件可访问的处理器状态正确的发生变化即可。

在这个视角下，我们可以重新审视此前的单周期CPU。单周期处理器是一个数字电路，其中包括时序器件和组合器件。这个处理器中所包括的时序部件，只有PC寄存器，程序计数器和内存。单周期处理器与ISA所描述的处理器模型几乎是一致的，实现起来也非常简单，只要在正确的修改这些时序器件的状态即可。

对于一条指令来说，如果要让其执行正确，必须确保当前访问的处理器状态是正确的。这一点在单周期CPU中是天然满足，无需额外支持的，因为处理器会一条一条的顺序执行指令，每条指令结束后，相应的时序部件的状态也就正确的修改，下一条指令去访问寄存器堆或内存，就能获取到正确的数据。但是这一点在流水线CPU中，是需要额外支持实现的。

### 单周期CPU下的指令执行过程

为了更好的理解计算机组成原理课程设计的实验内容。我们简单回顾一下单周期处理器中指令的执行过程，并简单对实验的部分错误进行指正。

CPU执行指令的过程，可以分为取指，译码，执行。

取指，即从存储器中取出指令，同时更新PC，在单周期处理器中，我们采用了一个寄存器阵列构成的存储器，这种存储器的特点是可以在当周期读回结果，这被称为组合逻辑读/异步读。然而真实的处理器中，我们的存储器可能是SRAM或是DRAM，可能需要若干个周期才能读回结果。

译码，在计算机组成原理实验课和计算机组成原理课程设计中，我们谈译码这一阶段，一般包括两个操作，一是根据指令判断指令类型，译出控制信号，二是根据译码得到的地址取回操作数。

> 在支持动态调度的处理器中，会将译码的这两个阶段进行拆分。

执行，执行的内容比较多，大致可以包括ALU执行，访存，写回寄存器。ALU执行根据译码阶段得到ALU控制信号，对操作数进行计算，得到正确的结果。访存阶段则是根据ALU运算的结果确定访存地址，对内存进行读写，写回模块则是将内存读取或ALU运算的结果存入寄存器堆当中。

运算功能上，单周期处理器只支持简单的加减，逻辑运算，移位运算。对于乘除法指令，单周期处理器中并没有要求实现。在访存功能上，单周期处理器实验当中只要求实现了lw和sw的访存指令，现实的代码中往往设计到单个字节的访问，比如在字符串操作的过程中，我们往往会对单个8bit数据进行操作，这点在单周期处理器中设计存储器模块是无法实现的。

单周期CPU的局限性还在于它要求所有指令在一个周期内完成，这一点在现实中是很难做到的，很多指令都不易在单周期完成，例如除法指令，除法指令往往需要多个周期才能执行完成，他没办法做到在单个周期内获取计算结果并改变CPU的状态。除此之外，现代CPU通过总线去访问外设，而通过总线访问外设和存储器，总线往往会在接受到请求后的若干个周期之后才将需要的数据发出或发回。因此，在计组实验的单周期CPU上，有很多操作是无法完成的。

> 但事实上，单周期CPU通过简单的扩展，就可以转换成多周期CPU，只要能够确保当一条指令执行完成后，CPU的状态发生正确的转换。如果我们不改变PC，我们就始终在执行当前PC的指令，如果我们知道结果运算完毕，才修改PC寄存器，取出下一条指令，我们就能让单周期CPU完成本不可能完成的多周期任务。（或许未来的计组实验中我们会基于此开发扩展实验XD

单周期CPU虽然采用了MIPS ISA指令编码，但是实际上它和MIPS ISA的定义是有出入的，比如关于跳转指令的延迟槽问题，`$0`寄存器读取恒为0，除此之外，单周期处理器中没有涉及异常的概念，对于加法减法的运算，MIPS ISA会在出现溢出时触发异常，关于异常的概念，我们会在后面的章节专门描述。

?> 关于单周期处理器的CPU，其写法上还有一些地方会与接下来要接触的TinyMIPS不一样，为了帮助大家理解，请思考以下几个问题：

?> 1. 我们在单周期处理器中，见过以下的写法，请问这种写法是否是必要的？
   ```verilog
   //alu_ct 模块中的控制信号
   always @(*)
   	if(!rst) alu_ct <= 0;
   //control 模块中的控制信号
   assign ct_rf_dst = rst?inst_r:0;
   ```
?> 2. 在单周期处理器中，我们采用了下降沿写内存，下降沿写寄存器，这种写法是否是必要的？如果我们统一使用posedge作为时钟触发条件，是否会导致处理器出错呢？

> 对于第一个问题，可以思考以下什么样的条件下会需要rst信号，如果不根据rst信号将对应的信号置0，是否会影响处理器状态的正确性。对于第二个问题，你可以简单的画一下时序图，这样或许会有所帮助。

### 小结

综上所述，单周期处理器离真正可用的处理器还有不小的距离，上述在单周期处理器实验中没有解决的问题，和在流水线CPU中出现的新问题，将会在计算机组成原理课程设计实验过程逐一解决，希望大家可以在后面的实验中，体会二者的区别。
