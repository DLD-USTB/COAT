## 流水线处理器

> By Zakilim

在数字逻辑课程的加法器实验中我们已经了解到，一段组合逻辑电路是存在延时的，从信号输入到结果输出需要一定的时间完成。在单周期处理器中，这一延时是相当长的，指令的吞吐率较低，因此，高性能处理器一般是不会采用单周期的方式来设计处理器的。

> 计算处理器的最小时钟周期，除了这里所说的组合逻辑时延，还需要考虑到除法器建立时间，触发器保持时间，寄存器更新延迟，时钟偏移等因素，更具体的内容，大家可以自行查阅相关资料。

流水线是数字电路设计中的一种常用手段，当执行一条指令的组合逻辑时延过长时，整个处理器系统的频率就会降低。为了提升处理器的性能，我们会考虑将其切分成多个流水级用于增大整个系统的吞吐量。流水线技术并不会缩短一条指令的执行时间（事实上一般可能会增长），但是会将指令的执行过程在时间上重叠起来，从而实现指令并行化。

### 流水线的典型划分

典型的五级流水线会将一条指令的执行划分成5个阶段，IF(Instruction Fetch, 取指), ID(Instruction Decode, 译码), EX(Execute, 执行), MEM(Memory, 访存), WB(Write Back, 写回)。

`IF`阶段，其功能是将PC发给存储器，从存储器中读取指令。对应着单周期处理器中的IFU，主要区别在于TinyMIPS中的存储器不在位于核内。

?>  IF阶段会通过ROM接口，访问到外部分存储器，可以看到，代码中，PC的复位值是 \`INIT_PC - 4，原因是什么？阅读 《计算机组成原理课程设计实验指导书 上》了解相关内容

`ID`阶段，其功能是根据指令进行译码，生成控制信号，读取操作数。这个部分对应着单周期处理器实验中的Control模块。

?> ID阶段为了便于理解，将模块拆分为了5个部分，

`EX`阶段，根据操作数计算出结果，对应单周期处理器中的ALU

?>

`MEM`阶段，访存并读取访存结果。同样的，由于TinyMIPS的存储器位于核外，在这个模块中主要用于生成对存储器的控制信号

?> 

`WB`阶段，主要负责更新处理器的通用寄存器状态。



### 控制信号的暂存

单周期处理器是一段组合逻辑，对于一条指令，译码电路会生成与之对应的控制信号和数据，在流水线中，存在着多条指令的不同阶段同时运行，那么这个过程要怎么保证控制信号的正确呢？

这就需要用到流水线的级间寄存器。级间寄存器会将上一级流水的输出信号带到下一级流水中来，从而确保每条指令的各个执行阶段都在正确的控制信号下运行。

比方说ID阶段的执行了一条指令add \$1, \$0,1,ID级会译码出EX级需要用的两个操作数，会告知EX级，ALU需要进行加法运算  

